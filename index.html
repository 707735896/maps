<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
		<title>智能铁鞋定位管理系统</title>
		<link rel="stylesheet" href="http://cache.amap.com/lbs/static/main1119.css" />
		<link rel="stylesheet" type="text/css" href="css/antd.min.css" />
		<link rel="stylesheet" type="text/css" href="css/public.css" />
		<script src="js/jquery-1.11.2.min.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript" src="http://webapi.amap.com/maps?v=1.4.6&key=e937e6cb850fe32217fede8fcd553f47&plugin=AMap.Geocoder&plugin=AMap.MarkerClusterer"></script>
		<style type="text/css">
			.amap-marker-content {
				opacity: 1 !important;
			}
			
			.amap-info-sharp {
				margin: -1px auto 0;
				background: url(http://webapi.amap.com/ui/1.0/ui/overlay/SimpleInfoWindow/assets/sharp.png) no-repeat -5px -15px;
				width: 52px;
				height: 9px !important;
			}
			
			.amap-info-close {
				color: #666;
			}
			
			.amap-ui-smp-ifwn-info-title,
			.amap-info-content {
				padding: 6px 25px 5px 5px;
			}
		</style>
	</head>

	<body>
		<div class="header-left">
			<div class="header-left-name">
				<img src="img/logo.png" width="25" height="25" style="vertical-align: middle;" />
				<span>智能铁鞋定位管理系统</span>
			</div>
			<div class="header-right"><span class="userName"></span><i id="quit" class="anticon anticon-poweroff" style="padding: 5px 0px 5px 15px; cursor: pointer;"><svg viewBox="64 64 896 896" class="" data-icon="poweroff" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M705.6 124.9a8 8 0 0 0-11.6 7.2v64.2c0 5.5 2.9 10.6 7.5 13.6a352.2 352.2 0 0 1 62.2 49.8c32.7 32.8 58.4 70.9 76.3 113.3a355 355 0 0 1 27.9 138.7c0 48.1-9.4 94.8-27.9 138.7a355.92 355.92 0 0 1-76.3 113.3 353.06 353.06 0 0 1-113.2 76.4c-43.8 18.6-90.5 28-138.5 28s-94.7-9.4-138.5-28a353.06 353.06 0 0 1-113.2-76.4A355.92 355.92 0 0 1 184 650.4a355 355 0 0 1-27.9-138.7c0-48.1 9.4-94.8 27.9-138.7 17.9-42.4 43.6-80.5 76.3-113.3 19-19 39.8-35.6 62.2-49.8 4.7-2.9 7.5-8.1 7.5-13.6V132c0-6-6.3-9.8-11.6-7.2C178.5 195.2 82 339.3 80 506.3 77.2 745.1 272.5 943.5 511.2 944c239 .5 432.8-193.3 432.8-432.4 0-169.2-97-315.7-238.4-386.7zM480 560h64c4.4 0 8-3.6 8-8V88c0-4.4-3.6-8-8-8h-64c-4.4 0-8 3.6-8 8v464c0 4.4 3.6 8 8 8z"></path></svg></i></div>
		</div>
		<div id="container" style="top: 50px;"></div>
		<div class="close-icon">
			<i class="anticon anticon-double-right"><svg viewBox="64 64 896 896" class="" data-icon="double-right" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M533.2 492.3L277.9 166.1c-3-3.9-7.7-6.1-12.6-6.1H188c-6.7 0-10.4 7.7-6.3 12.9L447.1 512 181.7 851.1A7.98 7.98 0 0 0 188 864h77.3c4.9 0 9.6-2.3 12.6-6.1l255.3-326.1c9.1-11.7 9.1-27.9 0-39.5zm304 0L581.9 166.1c-3-3.9-7.7-6.1-12.6-6.1H492c-6.7 0-10.4 7.7-6.3 12.9L751.1 512 485.7 851.1A7.98 7.98 0 0 0 492 864h77.3c4.9 0 9.6-2.3 12.6-6.1l255.3-326.1c9.1-11.7 9.1-27.9 0-39.5z"></path></svg></i>
		</div>
		<div class="show-icon">
			<i class="anticon anticon-double-left"><svg viewBox="64 64 896 896" class="" data-icon="double-left" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M272.9 512l265.4-339.1c4.1-5.2.4-12.9-6.3-12.9h-77.3c-4.9 0-9.6 2.3-12.6 6.1L186.8 492.3a31.99 31.99 0 0 0 0 39.5l255.3 326.1c3 3.9 7.7 6.1 12.6 6.1H532c6.7 0 10.4-7.7 6.3-12.9L272.9 512zm304 0l265.4-339.1c4.1-5.2.4-12.9-6.3-12.9h-77.3c-4.9 0-9.6 2.3-12.6 6.1L490.8 492.3a31.99 31.99 0 0 0 0 39.5l255.3 326.1c3 3.9 7.7 6.1 12.6 6.1H836c6.7 0 10.4-7.7 6.3-12.9L576.9 512z"></path></svg></i>
		</div>
		<div class="infoList">
			<div>
				<span class="ant-input-search ant-input-search-enter-button ant-input-affix-wrapper"><input id="search_val" placeholder="输入名称或IMEI" class="ant-input" type="text"><span class="ant-input-suffix"><button id="search" type="button" class="ant-btn ant-input-search-button ant-btn-primary"><span>搜 索</span></button</span>
				</span>
			</div>
			<div style="margin: 5px 0px; background-color: rgb(197, 197, 197); height: 0px; width: 100%;"></div>
			<!--<div class="btn-group" role="group" style="width: 100%; margin: 0px; background-color: rgb(232, 232, 232);"><button id="all" type="button" class="btn btn-default btn-sm btn-tab-activity" style="width: 33.33%;">全部(<span class="allnum"></span>)</button><button id="onLine" type="button" class="btn btn-default btn-sm" style="width: 33.33%;">在线(<span class="zxnum"></span>)</button><button id="offLine" type="button" class="btn btn-default btn-sm" style="width: 33.33%;">离线(<span class="lxnum"></span>)</button></div>-->
			<div class="getList" id="getList">
			</div>
		</div>
		<script src="//webapi.amap.com/ui/1.0/main.js?v=1.0.11"></script>
		<script type="text/javascript">
			Number.prototype.toFixed = function(len) {
				var add = 0;
				var s, temp;
				var s1 = this + "";
				var start = s1.indexOf(".");
				if(s1.substr(start + len + 1, 1) >= 5) add = 1;
				var temp = Math.pow(10, len);
				s = Math.floor(this * temp) + add;
				return s / temp;
			}

			$(function() {
				getData();
				init();
			})

			var arr = [];
			var newarr = [];
			var searchArr = '';
			var nowCenter = [];
			var cluster, markers = [];
			var markerList;
			var map = new AMap.Map("container", {
				resizeEnable: true,
				center: [105, 34],
				zoom: 4,
				//				zoomEnable: false
			});

			if(sessionStorage.getItem('userName')) {
				$('.userName').text(sessionStorage.getItem('userName'));
				//				arr = JSON.parse(sessionStorage.getItem('arr'));
			} else {
				window.location.href = 'login.html'
			}

			function getData() {
				if(searchArr){
					var data = {
						deviceid:"'"+searchArr+"'",
						userid: sessionStorage.getItem('userId')
					}
				}else {
					var data = {
						userid: sessionStorage.getItem('userId')
					}
				}
				$.ajax({
					type: "post",
					dataType: 'json',
					async: false,
					data: data,
					async: false,
					url: 'http://47.105.222.116:8088/boot/getBootInfoOnly',
					success: function(res) {
						arr = res.BootsInfo;
						$.each(arr, function(i, item) { //遍历每个点，我的业务要给每个点添加点击事件    
							item.locations = item.locations.split(',');
						});
					}
				});
			}

			function init() {

				$.each(arr, function(i, item) { //遍历每个点，我的业务要给每个点添加点击事件    
					var marker = new AMap.Marker({
						position: item.locations,
						icon: '//vdata.amap.com/icons/b18/1/2.png',
						content: '<img src="http://webapi.amap.com/theme/v1.3/markers/n/mark_bs.png" style="width: 19px; height: 33px; top: 0px; left: 0px;">',
						//					offset: new AMap.Pixel(-16, 6)
					})

					addClickHandler(item, marker); //给标记点添加点击事件
					markers.push(marker);
				});

				function addClickHandler(item, marker) {
					marker.on("click", function() {
						$('.' + item.deviceid).siblings().removeClass('selected');
						$('.' + item.deviceid).addClass('selected');
						openInfo(item, marker);
						map.setCenter(item.locations)
					});
				}

				addCluster(2);

				map.on('zoomchange', function() {
					var zoom = map.getZoom(); //获取当前地图级别
					if(zoom <= 9) {
						map.clearInfoWindow();
					}
				});

			}

			function openInfo(item, marker) {
				var d = new Date(item.updatetime);

				var h = Math.floor(d.getHours()) < 10 ? '0' + Math.floor(d.getHours()) : Math.floor(d.getHours());
				var m = Math.floor(d.getMinutes()) < 10 ? '0' + Math.floor(d.getMinutes()) : Math.floor(d.getMinutes());
				var s = Math.floor(d.getSeconds()) < 10 ? '0' + Math.floor(d.getSeconds()) : Math.floor(d.getSeconds());

				var times = d.getFullYear() + '-' + (d.getMonth() + 1) + '-' + d.getDate() + ' ' + h + ':' + m + ':' + s;

				item.updatetime = times;

				if(item.signalintensity == 0) {
					item.signalintensity = 'img/Signal-1.png'
				}

				if(item.signalintensity == 1) {
					item.signalintensity = 'img/Signal-1.png'
				}
				if(item.signalintensity == 2) {
					item.signalintensity = 'img/Signal-2.png'
				}
				if(item.signalintensity == 3) {
					item.signalintensity = 'img/Signal-3.png'
				}
				if(item.signalintensity == 4) {
					item.signalintensity = 'img/Signal-4.png'
				}
				if(item.signalintensity == 5) {
					item.signalintensity = 'img/Signal-5.png'
				}

				if(item.onlinestate == 0) {
					item.onlinestate = '离线';
				}

				if(item.onlinestate == 1) {
					item.onlinestate = '在线';
				}

				//item.locations = [item.longtitude, item.latitude];

				//坐標轉換
				//					AMap.convertFrom(item.locations, 'gps', function(status, result) {
				//						if(result.info === 'ok') {
				//							var lng = result.locations[0].lng; // Array.<LngLat>
				//							var lat = result.locations[0].lat;
				//							item.locations = [lng, lat];
				//						}
				//					});
				//地址轉換
				var geocoder = new AMap.Geocoder({
					radius: 1000,
					extensions: "all"
				});
				geocoder.getAddress(item.locations, function(status, result) {
					if(status === 'complete' && result.info === 'OK') {
						item.address = result.regeocode.formattedAddress;
						info(item, marker);
					}
				});
			};

			function info(item, marker) {
				if(item.uploadinterval == 1) {
					var title = '<span class="infoWindow-name">' + item.bootname + '</span><span class="infoWindow-name">（' + item.deviceid + '）</span><select class="test" id="' + item.id + '" style="height:24px;font-size:16px;"><option value="1" selected>1秒</option><option value="5">5秒</option><option value="10">10秒</option><option value="30">30秒</option><option value="60">1分钟</option><option value="120">2分钟</option><option value="300">5分钟</option></select>'
				} else if(item.uploadinterval == 5) {
					var title = '<span class="infoWindow-name">' + item.bootname + '</span><span class="infoWindow-name">（' + item.deviceid + '）</span><select class="test" id="' + item.id + '" style="height:24px;font-size:16px;"><option value="1">1秒</option><option value="5" selected>5秒</option><option value="10">10秒</option><option value="30">30秒</option><option value="60">1分钟</option><option value="120">2分钟</option><option value="300">5分钟</option></select>'
				} else if(item.uploadinterval == 10) {
					var title = '<span class="infoWindow-name">' + item.bootname + '</span><span class="infoWindow-name">（' + item.deviceid + '）</span><select class="test" id="' + item.id + '" style="height:24px;font-size:16px;"><option value="1" >1秒</option><option value="5">5秒</option><option value="10"selected>10秒</option><option value="30">30秒</option><option value="60">1分钟</option><option value="120">2分钟</option><option value="300">5分钟</option></select>'
				} else if(item.uploadinterval == 30) {
					var title = '<span class="infoWindow-name">' + item.bootname + '</span><span class="infoWindow-name">（' + item.deviceid + '）</span><select class="test" id="' + item.id + '" style="height:24px;font-size:16px;"><option value="1">1秒</option><option value="5">5秒</option><option value="10">10秒</option><option value="30" selected>30秒</option><option value="60">1分钟</option><option value="120">2分钟</option><option value="300">5分钟</option></select>'
				} else if(item.uploadinterval == 60) {
					var title = '<span class="infoWindow-name">' + item.bootname + '</span><span class="infoWindow-name">（' + item.deviceid + '）</span><select class="test" id="' + item.id + '" style="height:24px;font-size:16px;"><option value="1">1秒</option><option value="5">5秒</option><option value="10">10秒</option><option value="30">30秒</option><option value="60" selected>1分钟</option><option value="120">2分钟</option><option value="300">5分钟</option></select>'
				} else if(item.uploadinterval == 120) {
					var title = '<span class="infoWindow-name">' + item.bootname + '</span><span class="infoWindow-name">（' + item.deviceid + '）</span><select class="test" id="' + item.id + '" style="height:24px;font-size:16px;"><option value="1">1秒</option><option value="5">5秒</option><option value="10">10秒</option><option value="30">30秒</option><option value="60">1分钟</option><option value="120" selected>2分钟</option><option value="300">5分钟</option></select>'
				} else if(item.uploadinterval == 300) {
					var title = '<span class="infoWindow-name">' + item.bootname + '</span><span class="infoWindow-name">（' + item.deviceid + '）</span><select class="test" id="' + item.id + '" style="height:24px;font-size:16px;"><option value="1">1秒</option><option value="5">5秒</option><option value="10">10秒</option><option value="30">30秒</option><option value="60">1分钟</option><option value="120">2分钟</option><option value="300" selected>5分钟</option></select>'
				} else {
					var title = '<span class="infoWindow-name">' + item.bootname + '</span><span class="infoWindow-name">（' + item.deviceid + '）</span><select class="test" id="' + item.id + '" style="height:24px;font-size:16px;"><option value="1">1秒</option><option value="5">5秒</option><option value="10">10秒</option><option value="30">30秒</option><option value="60">1分钟</option><option value="120">2分钟</option><option value="300">5分钟</option></select>';
				}
				var tpl = '<div class="windowInfo"><div class="infoTitle"></div><div class="infoWindow-result">' + item.address + '</div><div class="infoWindow-other">(' + item.onlinestate + '/' + item.uploadmode + ' /' + item.batteryvolumn + '% /<img src="' + item.signalintensity + '"/>/' + item.updatetime + ')</div></div>';
				AMapUI.loadUI(['overlay/SimpleInfoWindow'], function(SimpleInfoWindow) {
					if(marker) {
						var infoWindow = new SimpleInfoWindow({
							infoTitle: title,
							infoBody: tpl,
							offset: new AMap.Pixel(-1, -20)
						}).open(map, marker.getPosition());
					}

				});
			}

			var count = markers.length;
			var _renderClusterMarker = function(context) {
				var factor = Math.pow(context.count / count, 1 / 18);
				var div = document.createElement('div');
				var Hue = 180 - factor * 180;
				var bgColor = 'hsla(' + Hue + ',100%,50%,0.7)';
				var fontColor = 'hsla(' + Hue + ',100%,20%,1)';
				var borderColor = 'hsla(' + Hue + ',100%,40%,1)';
				var shadowColor = 'hsla(' + Hue + ',100%,50%,1)';
				div.style.backgroundColor = bgColor;
				var size = Math.round(30 + Math.pow(context.count / count, 1 / 5) * 20);
				div.style.width = div.style.height = size + 'px';
				div.style.border = 'solid 1px ' + borderColor;
				div.style.borderRadius = size / 2 + 'px';
				div.style.boxShadow = '0 0 1px ' + shadowColor;
				div.innerHTML = context.count;
				div.style.lineHeight = size + 'px';
				div.style.color = fontColor;
				div.style.fontSize = '14px';
				div.style.textAlign = 'center';
				context.marker.setOffset(new AMap.Pixel(-size / 2, -size / 2));
				context.marker.setContent(div)
			};

			function addCluster(tag) {
				if(cluster) {
					cluster.setMap(null);
				}
				if(tag == 2) { //完全自定义
					cluster = new AMap.MarkerClusterer(map, markers, {
						gridSize: 80,
						renderClusterMarker: _renderClusterMarker
					});
					cluster.on('click', function(clus) {
						$('#getList').html('')
						map.setStatus({
							zoomEnable: true
						})
						//						if(clus.markers.length < 5) {
						$('.infoList').show();
						$('.close-icon').show();
						$('.show-icon').hide();
						var pointers = [];
						$.each(clus.markers, function(i, item) {
							var lat = clus.markers[i].F.position.lat;
							var lng = clus.markers[i].F.position.lng;
							pointers[i] = [lng, lat];
							newarr.push(arr.filter(function(item) {
								return [parseFloat(item.locations[0]).toFixed(6), parseFloat(item.locations[1]).toFixed(6)].toString() === pointers[i].toString();
							})[0]);
						});
						$.each(newarr, function(i, item) {
							openInfo(item);
						});

						initMap();
					})

				} else if(tag == 1) { //自定义图标
					var sts = [{
						url: "https://a.amap.com/jsapi_demos/static/images/blue.png", //聚合量在1-10
						size: new AMap.Size(32, 32),
						offset: new AMap.Pixel(-16, -16)
					}, {
						url: "https://a.amap.com/jsapi_demos/static/images/green.png", //聚合量在11-100
						size: new AMap.Size(32, 32),
						offset: new AMap.Pixel(-16, -16)
					}, {
						url: "https://a.amap.com/jsapi_demos/static/images/orange.png", //聚合量在101-1000
						size: new AMap.Size(36, 36),
						offset: new AMap.Pixel(-18, -18)
					}, {
						url: "https://a.amap.com/jsapi_demos/static/images/red.png", //聚合量在1001-10000
						size: new AMap.Size(48, 48),
						offset: new AMap.Pixel(-24, -24)
					}, {
						url: "https://a.amap.com/jsapi_demos/static/images/darkRed.png", //聚合量在10001-100000
						size: new AMap.Size(48, 48),
						offset: new AMap.Pixel(-24, -24)
					}];
					cluster = new AMap.MarkerClusterer(map, markers, {
						styles: sts,
						gridSize: 80
					});
				} else { //默认样式
					cluster = new AMap.MarkerClusterer(map, markers, {
						gridSize: 80
					});
				}
			}

			setInterval(function() {
				markers = [];
				//清空數據和坐標
				if(markerList) {
					markerList.render([]);
					markerList.clearData();
				}
				map.clearInfoWindow(); //清空已打開的彈窗
				getData();
				init();
				$('#getList').html('');

				var zoom = map.getZoom();
				if(arr.length !== 2 && zoom >= 13) {
					flesh();
				} else if(arr.length == 2 && zoom >= 9) {
					flesh();
				}

				//点击列表时
				$('.info').click(function() {
					$(this).siblings().removeClass('selected');
					$(this).addClass('selected');
					var data = {
						'bootname': $(this).find('.bootname').text(),
						'deviceid': $(this).attr('id')
					}
					$.ajax({
						type: "post",
						data: data,
						dataType: 'json',
						async: false,
						url: 'http://47.105.222.116:8088/boot/getBootInfo',
						success: function(res) {
							arr = res.BootsInfo;
							$.each(arr, function(i, item) { //遍历每个点，我的业务要给每个点添加点击事件    
								item.locations = item.locations.split(',');
								marker = new AMap.Marker({
									position: item.locations,
									icon: '//vdata.amap.com/icons/b18/1/2.png',
									content: '<img src="http://webapi.amap.com/theme/v1.3/markers/n/mark_bs.png" style="width: 19px; height: 33px; top: 0px; left: 0px;">',
									//					offset: new AMap.Pixel(-16, 6)
								})

								map.setCenter(item.locations);
								openInfo(item, marker);
							});

						}
					});
				})

				//				var zoom = map.getZoom();
				//				if(arr.length !== 2 && zoom >= 13) {
				//					initMap();
				//				} else if(arr.length == 2 && zoom >= 9) {
				//					initMap();
				//				}

			}, 5000)

			function flesh() {
				$.each(arr, function(i, item) { //遍历每个点，我的业务要给每个点添加点击事件    
					var d = new Date(item.updatetime);

					var h = Math.floor(d.getHours()) < 10 ? '0' + Math.floor(d.getHours()) : Math.floor(d.getHours());
					var m = Math.floor(d.getMinutes()) < 10 ? '0' + Math.floor(d.getMinutes()) : Math.floor(d.getMinutes());
					var s = Math.floor(d.getSeconds()) < 10 ? '0' + Math.floor(d.getSeconds()) : Math.floor(d.getSeconds());

					var times = d.getFullYear() + '-' + (d.getMonth() + 1) + '-' + d.getDate() + ' ' + h + ':' + m + ':' + s;

					item.updatetime = times;

					if(item.signalintensity == 0) {
						item.signalintensity = 'img/Signal-1.png'
					}

					if(item.signalintensity == 1) {
						item.signalintensity = 'img/Signal-1.png'
					}
					if(item.signalintensity == 2) {
						item.signalintensity = 'img/Signal-2.png'
					}
					if(item.signalintensity == 3) {
						item.signalintensity = 'img/Signal-3.png'
					}
					if(item.signalintensity == 4) {
						item.signalintensity = 'img/Signal-4.png'
					}
					if(item.signalintensity == 5) {
						item.signalintensity = 'img/Signal-5.png'
					}

					if(item.onlinestate == 0) {
						item.onlinestate = '离线';
					}

					if(item.onlinestate == 1) {
						item.onlinestate = '在线';
					}

					//地址轉換
					var geocoder = new AMap.Geocoder({
						radius: 1000,
						extensions: "all"
					});
					geocoder.getAddress(item.locations, function(status, result) {
						if(status === 'complete' && result.info === 'OK') {
							item.address = result.regeocode.formattedAddress;
						}
					});

					var tpl = '<div class="info ' + item.deviceid + '" id="' + item.id + '"><div class="infoTitle"><span class="bootname">' + item.bootname + '</span><span class="bootId">(' + item.deviceid + ')</span></div><div class="infoWindow-other">(<span class="isOnline">' + item.onlinestate + '</span> /' + item.uploadmode + ' /' + item.batteryvolumn + '% /<img src="' + item.signalintensity + '"/>/' + item.updatetime + ')</div></div>';
					$('#getList').append(tpl);
				});
			}

			function initMap() {

				$.each(arr, function(i, item) {

					var d = new Date(item.updatetime);

					var h = Math.floor(d.getHours()) < 10 ? '0' + Math.floor(d.getHours()) : Math.floor(d.getHours());
					var m = Math.floor(d.getMinutes()) < 10 ? '0' + Math.floor(d.getMinutes()) : Math.floor(d.getMinutes());
					var s = Math.floor(d.getSeconds()) < 10 ? '0' + Math.floor(d.getSeconds()) : Math.floor(d.getSeconds());

					var times = d.getFullYear() + '-' + (d.getMonth() + 1) + '-' + d.getDate() + ' ' + h + ':' + m + ':' + s;

					item.updatetime = times;

					if(item.signalintensity == 0) {
						item.signalintensity = 'img/Signal-1.png'
					}

					if(item.signalintensity == 1) {
						item.signalintensity = 'img/Signal-1.png'
					}
					if(item.signalintensity == 2) {
						item.signalintensity = 'img/Signal-2.png'
					}
					if(item.signalintensity == 3) {
						item.signalintensity = 'img/Signal-3.png'
					}
					if(item.signalintensity == 4) {
						item.signalintensity = 'img/Signal-4.png'
					}
					if(item.signalintensity == 5) {
						item.signalintensity = 'img/Signal-5.png'
					}

					if(item.onlinestate == 0) {
						item.onlinestate = '离线';
					}

					if(item.onlinestate == 1) {
						item.onlinestate = '在线';
					}

					//地址轉換
					var geocoder = new AMap.Geocoder({
						radius: 1000,
						extensions: "all"
					});
					geocoder.getAddress(item.locations, function(status, result) {
						if(status === 'complete' && result.info === 'OK') {
							item.address = result.regeocode.formattedAddress;
						}
					});
				});

				AMapUI.loadUI(['misc/MarkerList'], function(MarkerList) {

					markerList = new MarkerList({
						//关联的map对象
						map: map,

						//列表的dom容器的id
						listContainer: 'getList',

						//选中状态（通过点击列表或者marker）时在Marker和列表节点上添加的class，可以借此编写css控制选中时的展示效果
						selectedClassNames: 'selected',

						//返回数据项的Id
						getDataId: function(dataItem, index) {
							//index表示该数据项在数组中的索引位置，从0开始，如果确实没有id，可以返回index代替
							return dataItem.id;
						},
						//返回数据项的位置信息，需要是AMap.LngLat实例，或者是经纬度数组，比如[116.789806, 39.904989]
						getPosition: function(dataItem) {
							return dataItem.locations;
						},
						getMarker: function(dataItem, context, recycledMarker) {
							var content = '标注: ' + (context.index + 1) + '',
								label = {
									offset: new AMap.Pixel(16, 18),
									//								content: content
								};

							if(recycledMarker) {
								//存在可回收利用的marker,直接setLabel返回
								recycledMarker.setLabel(label);
								return recycledMarker;
							}
							//返回一个新的Marker
							return new AMap.Marker({
								label: label
							});
						},
						getInfoWindow: function(dataItem, context, recycledInfoWindow) {
							if(dataItem.uploadinterval == 1) {
								var tpl = '<div class="windowInfo"><div class="infoTitle" style="padding-bottom:5px;border-bottom: 1px solid #ccc;color: rgba(0, 0, 0, .85);"><span class="infoWindow-name"><%- dataItem.bootname %></span><span class="infoWindow-name">（<%- dataItem.deviceid %>）</span><select id="<%- dataItem.id %>" class="test" style="height:24px;font-size:16px;"><option value="1" selected>1秒</option><option value="5">5秒</option><option value="10">10秒</option><option value="30">30秒</option><option value="60">1分钟</option><option value="120">2分钟</option><option value="300">5分钟</option></select></div><div class="infoWindow-result"><%- dataItem.address %></div><div class="infoWindow-other">(<%- dataItem.onlinestate %> /<%- dataItem.uploadmode %> /<%- dataItem.batteryvolumn %>% /<img src="<%- dataItem.signalintensity %>"/>/<%- dataItem.updatetime %>)</div></div>';
							} else
							if(dataItem.uploadinterval == 5) {
								var tpl = '<div class="windowInfo"><div class="infoTitle" style="padding-bottom:5px;border-bottom: 1px solid #ccc;color: rgba(0, 0, 0, .85);"><span class="infoWindow-name"><%- dataItem.bootname %></span><span class="infoWindow-name">（<%- dataItem.deviceid %>）</span><select id="<%- dataItem.id %>" class="test <%- dataItem.id %>" style="height:24px;font-size:16px;"><option value="1">1秒</option><option value="5" selected>5秒</option><option value="10">10秒</option><option value="30">30秒</option><option value="60">1分钟</option><option value="120">2分钟</option><option value="300">5分钟</option></select></div><div class="infoWindow-result"><%- dataItem.address %></div><div class="infoWindow-other">(<%- dataItem.onlinestate %> /<%- dataItem.uploadmode %> /<%- dataItem.batteryvolumn %>% /<img src="<%- dataItem.signalintensity %>"/>/<%- dataItem.updatetime %>)</div></div>';
							} else
							if(dataItem.uploadinterval == 10) {
								var tpl = '<div class="windowInfo"><div class="infoTitle" style="padding-bottom:5px;border-bottom: 1px solid #ccc;color: rgba(0, 0, 0, .85);"><span class="infoWindow-name"><%- dataItem.bootname %></span><span class="infoWindow-name">（<%- dataItem.deviceid %>）</span><select id="<%- dataItem.id %>" class="test <%- dataItem.id %>" style="height:24px;font-size:16px;"><option value="1">1秒</option><option value="5">5秒</option><option value="10" selected>10秒</option><option value="30">30秒</option><option value="60">1分钟</option><option value="120">2分钟</option><option value="300">5分钟</option></select></div><div class="infoWindow-result"><%- dataItem.address %></div><div class="infoWindow-other">(<%- dataItem.onlinestate %> /<%- dataItem.uploadmode %> /<%- dataItem.batteryvolumn %>% /<img src="<%- dataItem.signalintensity %>"/>/<%- dataItem.updatetime %>)</div></div>';
							} else
							if(dataItem.uploadinterval == 30) {
								var tpl = '<div class="windowInfo"><div class="infoTitle" style="padding-bottom:5px;border-bottom: 1px solid #ccc;color: rgba(0, 0, 0, .85);"><span class="infoWindow-name"><%- dataItem.bootname %></span><span class="infoWindow-name">（<%- dataItem.deviceid %>）</span><select id="<%- dataItem.id %>" class="test <%- dataItem.id %>" style="height:24px;font-size:16px;"><option value="1">1秒</option><option value="5">5秒</option><option value="10">10秒</option><option value="30" selected>30秒</option><option value="60">1分钟</option><option value="120">2分钟</option><option value="300">5分钟</option></select></div><div class="infoWindow-result"><%- dataItem.address %></div><div class="infoWindow-other">(<%- dataItem.onlinestate %> /<%- dataItem.uploadmode %> /<%- dataItem.batteryvolumn %>% /<img src="<%- dataItem.signalintensity %>"/>/<%- dataItem.updatetime %>)</div></div>';
							} else
							if(dataItem.uploadinterval == 60) {
								var tpl = '<div class="windowInfo"><div class="infoTitle" style="padding-bottom:5px;border-bottom: 1px solid #ccc;color: rgba(0, 0, 0, .85);"><span class="infoWindow-name"><%- dataItem.bootname %></span><span class="infoWindow-name">（<%- dataItem.deviceid %>）</span><select id="<%- dataItem.id %>" class="test <%- dataItem.id %>" style="height:24px;font-size:16px;"><option value="1">1秒</option><option value="5">5秒</option><option value="10">10秒</option><option value="30">30秒</option><option value="60" selected>1分钟</option><option value="120">2分钟</option><option value="300">5分钟</option></select></div><div class="infoWindow-result"><%- dataItem.address %></div><div class="infoWindow-other">(<%- dataItem.onlinestate %> /<%- dataItem.uploadmode %> /<%- dataItem.batteryvolumn %>% /<img src="<%- dataItem.signalintensity %>"/>/<%- dataItem.updatetime %>)</div></div>';
							} else
							if(dataItem.uploadinterval == 120) {
								var tpl = '<div class="windowInfo"><div class="infoTitle" style="padding-bottom:5px;border-bottom: 1px solid #ccc;color: rgba(0, 0, 0, .85);"><span class="infoWindow-name"><%- dataItem.bootname %></span><span class="infoWindow-name">（<%- dataItem.deviceid %>）</span><select id="<%- dataItem.id %>" class="test <%- dataItem.id %>" style="height:24px;font-size:16px;"><option value="1">1秒</option><option value="5">5秒</option><option value="10">10秒</option><option value="30">30秒</option><option value="60">1分钟</option><option value="120" selected>2分钟</option><option value="300">5分钟</option></select></div><div class="infoWindow-result"><%- dataItem.address %></div><div class="infoWindow-other">(<%- dataItem.onlinestate %> /<%- dataItem.uploadmode %> /<%- dataItem.batteryvolumn %>% /<img src="<%- dataItem.signalintensity %>"/>/<%- dataItem.updatetime %>)</div></div>';
							} else
							if(dataItem.uploadinterval == 300) {
								var tpl = '<div class="windowInfo"><div class="infoTitle" style="padding-bottom:5px;border-bottom: 1px solid #ccc;color: rgba(0, 0, 0, .85);"><span class="infoWindow-name"><%- dataItem.bootname %></span><span class="infoWindow-name">（<%- dataItem.deviceid %>）</span><select id="<%- dataItem.id %>" class="test <%- dataItem.id %>" style="height:24px;font-size:16px;"><option value="1">1秒</option><option value="5">5秒</option><option value="10">10秒</option><option value="30">30秒</option><option value="60">1分钟</option><option value="120">2分钟</option><option value="300" selected>5分钟</option></select></div><div class="infoWindow-result"><%- dataItem.address %></div><div class="infoWindow-other">(<%- dataItem.onlinestate %> /<%- dataItem.uploadmode %> /<%- dataItem.batteryvolumn %>% /<img src="<%- dataItem.signalintensity %>"/>/<%- dataItem.updatetime %>)</div></div>';
							} else {
								var tpl = '<div class="windowInfo"><div class="infoTitle" style="padding-bottom:5px;border-bottom: 1px solid #ccc;color: rgba(0, 0, 0, .85);"><span class="infoWindow-name"><%- dataItem.bootname %></span><span class="infoWindow-name">（<%- dataItem.deviceid %>）</span><select id="<%- dataItem.id %>" class="test <%- dataItem.id %>" style="height:24px;font-size:16px;"><option value="1">1秒</option><option value="5">5秒</option><option value="10">10秒</option><option value="30">30秒</option><option value="60">1分钟</option><option value="120">2分钟</option><option value="300">5分钟</option></select></div><div class="infoWindow-result"><%- dataItem.address %></div><div class="infoWindow-other">(<%- dataItem.onlinestate %> /<%- dataItem.uploadmode %> /<%- dataItem.batteryvolumn %>% /<img src="<%- dataItem.signalintensity %>"/>/<%- dataItem.updatetime %>)</div></div>';
							}
							//MarkerList.utils.template支持underscore语法的模板
							var content = MarkerList.utils.template(tpl, {
								dataItem: dataItem,
								dataIndex: context.index
							});
							if(recycledInfoWindow) {
								//存在可回收利用的infoWindow, 直接setContent返回
								recycledInfoWindow.setContent(content);
								return recycledInfoWindow;
							}
							//返回一个新的InfoWindow
							return new AMap.InfoWindow({
								offset: new AMap.Pixel(0, -23),
								content: content
							});
						},
						getListElement: function(dataItem, context, recycledListElement) {
							if(dataItem.onlinestate == '在线') {
								var tpl = '<div class="info <%- dataItem.deviceid %>"><div class="infoTitle"><span class="bootname"><%- dataItem.bootname %></span><span class="bootId">(<%- dataItem.deviceid %>)</span></div><div class="infoWindow-other">(<span class="isOnline"><%- dataItem.onlinestate %></span> /<%- dataItem.uploadmode %> /<%- dataItem.batteryvolumn %>% /<img src="<%- dataItem.signalintensity %>"/>/<%- dataItem.updatetime %>)</div></div>';
							} else {
								var tpl = '<div class="info <%- dataItem.deviceid %>"><div class="infoTitle"><span class="bootname"><%- dataItem.bootname %></span><span class="bootId">(<%- dataItem.deviceid %>)</span></div><div class="infoWindow-other">(<span class="isOffline"><%- dataItem.onlinestate %></span> /<%- dataItem.uploadmode %> /<%- dataItem.batteryvolumn %>% /<img src="<%- dataItem.signalintensity %>"/>/<%- dataItem.updatetime %>)</div></div>';
							}

							var content = MarkerList.utils.template(tpl, {
								dataItem: dataItem,
								dataIndex: context.index
							});
							if(recycledListElement) {
								//存在可回收利用的listElement, 直接更新内容返回
								recycledListElement.innerHTML = content;
								return recycledListElement;
							}
							//返回一段html，MarkerList将利用此html构建一个新的dom节点
							return content;
						}
					});

					//监听选中改变
					markerList.on('selectedChanged', function(event, info) {
						//						console.log(event, info);
					});

					//监听Marker和ListElement上的点击
					markerList.on('markerClick listElementClicmarkersk', function(event, record) {

					});

					//展示该数据
					markerList.render(arr);

					map.on('zoomchange', function() {
						var zoom = map.getZoom(); //获取当前地图级别
						console.log(zoom);
						console.log(arr.length)
						if(arr.length > 2 && zoom <= 13) {
							markerList.clearData();
						} else {
							if(arr.length == 2 && zoom <= 9) {
								markerList.clearData();
							}

							//							if(arr.length == 1 && zoom <= 9) {
							//								markerList.clearData();
							//							}
						}

					});

				});
			}

			//搜索
			$('#search').on('click', function() {
				cluster.clearMarkers(); //清空聚合量
				markers = [];
				//清空數據和坐標
				if(markerList) {
					markerList.render([]);
					markerList.clearData();
				}
				map.clearInfoWindow(); //清空已打開的彈窗
				$('#getList').html('');
				var data = {
					'bootname': $('#search_val').val(),
					'deviceid': '"'+$('#search_val').val()+'"'
				}
				$.ajax({
					type: "post",
					data: data,
					dataType: 'json',
					async: false,
					url: 'http://47.105.222.116:8088/boot/getBootInfo',
					success: function(res) {
						arr = res.BootsInfo;
						console.log(arr);
						searchArr = '';
						var search = [];
						$.each(arr, function(i, item) { //遍历每个点，我的业务要给每个点添加点击事件    
							item.locations = item.locations.split(',');
							search.push(item.deviceid);
							marker = new AMap.Marker({
								position: item.locations,
								icon: '//vdata.amap.com/icons/b18/1/2.png',
								content: '<img src="http://webapi.amap.com/theme/v1.3/markers/n/mark_bs.png" style="width: 19px; height: 33px; top: 0px; left: 0px;">',
								//					offset: new AMap.Pixel(-16, 6)
							})
							searchArr = search.toString();
							addClickHandler(item, marker); //给标记点添加点击事件
							markers.push(marker);
						});

						function addClickHandler(item, marker) {
							marker.on("click", function() {
								openInfo(item, marker)
							});
						}
						addCluster(2);
					}
				});
				initMap();
			})

			//隐藏
			$('.close-icon').on('click', function() {
				$('.infoList').hide();
				$(this).hide();
				$('.show-icon').show();
			})

			//显示
			$('.show-icon').on('click', function() {
				$('.infoList').show();
				$(this).hide();
				$('.close-icon').show();
			})

			//退出登录
			$('#quit').on('click', function() {
				sessionStorage.clear();
				window.location.href = 'login.html';
			})

			$('body').on('change', 'select', function() {
				var data = {
					id: $(this).attr('id'),
					uploadinterval: $(this).val()
				}
				$.ajax({
					type: "post",
					data: data,
					dataType: 'json',
					url: 'http://47.105.222.116:8088/boot/updateBootInfo',
					success: function(res) {
						alert(res.msg);
					}
				});
			})
		</script>
	</body>

</html>